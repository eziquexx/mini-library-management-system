name: Deploy to Lightsail

# 동일한 워크플로우가 여러 번 실행될 때, 이전 실행이 완료되지 않았다면 취소하고 현재 실행만 진행하도록 설정합니다.
concurrency:
  group: build-and-deploy
  cancel-in-progress: true

on:
  # 'main' 브랜치에 코드가 push될 때 이 워크플로우를 실행합니다.
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    # 워크플로우를 실행할 가상 환경을 지정합니다. (일반적으로 Ubuntu 최신 버전 사용)
    runs-on: ubuntu-latest

    steps:
      # 1단계: GitHub 리포지토리 체크아웃 (현재 브랜치의 코드를 가져옵니다.)
      - name: Checkout
        uses: actions/checkout@v4

      # 2단계: Docker Hub 로그인 (빌드된 이미지를 푸시하기 위해 필요합니다.)
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }} # GitHub Secrets에 저장된 Docker Hub 사용자 이름
          password: ${{ secrets.DOCKER_PASSWORD }} # GitHub Secrets에 저장된 Docker Hub 비밀번호/Access Token

      # 3단계: Node.js 및 Frontend 빌드 준비
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies for Frontend
        working-directory: ./frontend # frontend 폴더에서 작업
        run: npm install

      - name: Build React app
        working-directory: ./frontend
        run: npm run build # React/Vite 앱을 빌드하여 dist 폴더 생성

      # 4단계: Frontend Docker 이미지 빌드
      - name: Build Docker image for Frontend
        working-directory: ./frontend
        run: |
          echo "--- Creating .env.production for Build ---"

          # GitHub Secrets에 있는 API URL을 읽어 .env.production 파일 생성 (Frontend Dockerfile에서 사용)
          echo "VITE_API_URL=${{ secrets.API_URL }}" > .env.production

          # frontend/Dockerfile을 사용하여 library-front:latest 이미지 빌드
          docker build -t library-front:latest .

      # 5단계: Backend Docker 이미지 빌드
      - name: Build Docker image for Backend
        working-directory: ./backend
        run: |
          # backend/Dockerfile을 사용하여 library-back:latest 이미지 빌드
          docker build -t library-back:latest .
      
      # 6단계: Docker 이미지 태그 및 푸시 (Docker Hub에 저장)
      - name: Tag and Push Docker images to Docker Hub
        run: |
          # 빌드된 이미지를 Docker Hub 계정 이름으로 태그 변경
          docker tag library-front:latest ${{ secrets.DOCKER_USERNAME }}/library-front:latest
          docker tag library-back:latest ${{ secrets.DOCKER_USERNAME }}/library-back:latest
          # Docker Hub에 최종 이미지 푸시
          docker push ${{ secrets.DOCKER_USERNAME }}/library-front:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/library-back:latest
      
      # 7단계: SSH 설정 (Lightsail에 접속하기 위한 준비)
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          # GitHub Secrets에 있는 SSH Private Key를 파일로 저장
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Lightsail 서버 IP의 호스트 키를 known_hosts에 추가 (첫 접속 시 보안 경고 방지)
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_IP }} >> ~/.ssh/known_hosts

      # 8단계: GitHub Secrets에서 .env 파일 내용 읽어서 파일로 저장
      - name: Create .env file from Secrets
        # Secrets에 저장된 전체 환경 변수 내용을 .env 파일로 생성
        run: echo "${{ secrets.MY_ENV_FILE }}" > .env

      # 9단계: .env 파일 Lightsail로 업로드
      - name: Upload .env file to Lightsail
        run: |
          # scp (Secure Copy)를 이용해 로컬의 .env 파일을 Lightsail 서버의 홈 디렉토리로 복사
          scp -i ~/.ssh/id_rsa .env ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_IP }}:/home/ubuntu/.env
      
      # 10단계: AWS Lightsail에서 Docker 이미지 다운로드 및 컨테이너 실행
      # 10-1: Back-end 정리 & pull (SSH 접속하여 서버에서 실행)
      - name: Deploy Back-end to Lightsail
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.LIGHTSAIL_IP }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            echo "--- Back-end 정리 및 Pull 시작 ---"

            # 컨테이너 ID 찾기 (Back)
            CONTAINER_ID_BACK=$(docker ps -a -q --filter "name=my-backend-app")

            # 기존 컨테이너의 PID를 찾아 강제 종료 (컨테이너가 비정상 종료 상태일 때 대비)
            BACK_PID=$(sudo docker inspect --format '{{.State.Pid}}' $CONTAINER_ID_BACK 2>/dev/null)
            sudo kill -9 $BACK_PID || true

            # 기존 컨테이너 강제 삭제
            docker rm -f $CONTAINER_ID_BACK || true

            # (옵션) 불필요한 Docker 자원 정리
            # docker system prune -f

            # Docker Hub에서 최신 이미지 다운로드
            docker pull ${{ secrets.DOCKER_USERNAME }}/library-back:latest

            echo "--- Back-end Pull 완료 ---"
            
      # 10-2: Front-end 정리 & pull (순서 변경 가능하지만, 일반적으로 백엔드를 먼저 배포하는 경우도 있음)
      - name: Deploy Front-end to Lightsail
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.LIGHTSAIL_IP }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            echo "--- Front-end 정리 및 Pull 시작 ---"

            # 컨테이너 ID 찾기 (Front)
            CONTAINER_ID_FRONT=$(docker ps -a -q --filter "name=my-react-app")

            # 기존 컨테이너의 PID를 찾아 강제 종료 (컨테이너가 비정상 종료 상태일 때 대비)
            FRONT_PID=$(sudo docker inspect --format '{{.State.Pid}}' $CONTAINER_ID_FRONT 2>/dev/null)
            sudo kill -9 $FRONT_PID || true

            # 기존 컨테이너 강제 삭제
            docker rm -f $CONTAINER_ID_FRONT || true

            # (옵션) 불필요한 Docker 자원 정리
            # docker system prune -f

            # Docker Hub에서 최신 이미지 다운로드
            docker pull ${{ secrets.DOCKER_USERNAME }}/library-front:latest

            echo "--- Front-end Pull 완료 ---"
      
      # 10-3: Front-end, Back-end 컨테이너 실행 (최신 이미지를 이용하여 컨테이너 구동)
      - name: Container start
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.LIGHTSAIL_IP }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            echo "--- 컨테이너 실행 시작 ---"

            # 1. Back-end 컨테이너 실행 (8080 포트, 서버에 복사된 .env 파일 사용)
            docker run -d -p 8080:8080 --name my-backend-app --env-file /home/ubuntu/.env ${{ secrets.DOCKER_USERNAME }}/library-back:latest

            # 2. Front-end 컨테이너 실행 (80 포트, 서버에 복사된 .env 파일 사용)
            docker run -d -p 80:80 --name my-react-app --env-file /home/ubuntu/.env ${{ secrets.DOCKER_USERNAME }}/library-front:latest

            # 3. 기존 'none' 이미지 (태그가 없어진 이미지) 삭제하여 디스크 공간 확보
            docker images -f "dangling=true" -q | xargs -r docker rmi

            echo "--- 배포 완료 ---"